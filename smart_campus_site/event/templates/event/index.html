<HTML>

<head>
    {% include "navigation/header.html" %}
    <title>Smart Campus in W311</title>
</head>

<body>
    <div style="background-color: #666666; height: 60px;">
        <div class="container">
            {% include "navigation/navbar.html" %}
            <div style="height: 30px;"></div>

            <form id="get-venue-data-form" method="GET" action="/getVenueData">
                {% csrf_token %}
                <fieldset>
                    <legend>Get venue data</legend>
                    <div class="mb-3 w-50">
                        <label for="venue" class="form-label">Venue</label>
                        <select id="venue" class="form-select" required>
                        </select>
                    </div>
                    <div class="mb-3 w-50">
                        <label for="date" class="form-label">Date</label>
                        <select id="date" class="form-select" required>
                        </select>
                    </div>
                    <div class="mb-3 w-50">
                        <label for="time" class="form-label">Time</label>
                        <select id="time" class="form-select" required>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </fieldset>
            </form>
            <table class="table table-dark">
                <thead>
                    <tr>
                        <td>Venue</td>
                        <td>Date</td>
                        <td>Start</td>
                        <td>End</td>
                        <td>Event</td>
                        <td>Instructor</td>
                    </tr>
                </thead>
                <tbody id="result">
                    <!--
            {% for event in selection %}
            <tr>
                <td>{{event.venue}}</td>
                <td>{{event.date}}</td>
                <td>{{event.time_start|date:'H:i A'}}</td>
                <td>{{event.time_end|date:'H:i A'}}</td>
                <td>{{event.event}}</td>
                <td>{{event.instructor}}</td>
            </tr>
            {% endfor %}
        -->
                </tbody>
            </table>
        </div>

        {% include "navigation/footer.html" %}
        <script>
            $(document).ready(function () {

                $("#venue").empty();
                $("#date").empty();
                $("#time").empty();

                let selection = JSON.parse('{{ selection|escapejs }}');
                venue_selected = Object.keys(selection)[0];
                date_selected = Object.keys(selection[venue_selected])[0];
                time_selected = selection[venue_selected][date_selected][0];

                for (let v in selection) {
                    $("#venue").append(`<option value="${v}">${v}</option>`);
                }

                for (let d in selection[venue_selected]) {
                    $("#date").append(`<option value="${d}">${d}</option>`);
                }

                for (let i = 0; i < selection[venue_selected][date_selected].length; i++) {
                    t = selection[venue_selected][date_selected][i]
                    $("#time").append(`<option value="${t}">${convertTime(t)}</option>`);
                }

                $("#venue").on("change", function (e) {
                    console.log("venue change");
                    venue_selected = $("#venue").val();
                    date_selected = Object.keys(selection[venue_selected])[0];
                    time_selected = selection[venue_selected][date_selected][0];
                    console.log("venue_selected: " + venue_selected);
                    console.log("date_selected: " + date_selected);
                    console.log("time_selected: " + time_selected);
                    console.log("venue change");

                    $("#date").empty();
                    $("#time").empty();

                    for (let d in selection[venue_selected]) {
                        $("#date").append(`<option value="${d}">${d}</option>`);
                    }

                    for (let i = 0; i < selection[venue_selected][date_selected].length; i++) {
                        t = selection[venue_selected][date_selected][i]
                        $("#time").append(`<option value="${t}">${convertTime(t)}</option>`);
                    }
                });

                $("#date").on("change", function (e) {
                    console.log("date change");
                    date_selected = $("#date").val();
                    time_selected = selection[venue_selected][date_selected][0];
                    console.log("date_selected: " + date_selected);
                    console.log("time_selected: " + time_selected);
                    console.log("date change");

                    $("#time").empty();
                    for (let i = 0; i < selection[venue_selected][date_selected].length; i++) {
                        t = selection[venue_selected][date_selected][i]
                        $("#time").append(`<option value="${t}">${convertTime(t)}</option>`);
                    }
                });

                $('#get-venue-data-form').on('submit', function (event) {
                    event.preventDefault();
                    console.log("form submitted!");
                    getVenueData();
                });
            });

            function convertTime(arr) {
                return arr[0] + " - " + arr[1];
            }

            function getVenueData() {
                $.ajax({
                    url: "getVenueData",
                    type: "GET",
                    data: {
                        venue: $('#venue').val(),
                        date: $('#date').val(),
                        time: $('#time').val()
                    },

                    success: function (json) {
                        console.log(json);
                        console.log("success");
                        $("#result").empty();
                        for(let i = 0;i < json[0];i++) {
                            console.log(i)
                        }
                    },

                    error: function (xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                });
            };
        </script>
</body>

</HTML>